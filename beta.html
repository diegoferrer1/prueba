<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palau - Menú Digital</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Bricolage+Grotesque:opsz,wght@10..48,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- SortableJS for Admin Panel -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-brand {
            font-family: 'Bricolage Grotesque', sans-serif;
        }
        /* Estilos para el autocompletado de Chrome */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #eef2ff inset !important;
            -webkit-text-fill-color: #1e293b !important;
        }
        /* Animaciones */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .fade-out { animation: fadeOut 0.5s ease-in forwards; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .sortable-ghost { opacity: 0.4; background: #c7d2fe; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- App Container -->
    <div id="app-container">

        <!-- ======================================================= -->
        <!-- VISTA PÚBLICA DEL MENÚ                                   -->
        <!-- ======================================================= -->
        <div id="public-view">
            <header class="p-4 flex justify-between items-center sticky top-0 bg-slate-50/80 backdrop-blur-sm z-30">
                <a href="#" class="font-brand text-2xl font-bold text-indigo-600">Palau</a>
                <a href="#admin" id="admin-link" class="text-sm font-semibold text-slate-600 hover:text-indigo-600 transition-colors">Admin</a>
            </header>

            <main class="container mx-auto px-4 pb-32">
                <section class="text-center py-8">
                    <img src="https://raw.githubusercontent.com/rarmate/menu-palau/main/palau.png" alt="Logo de Palau" class="w-32 h-32 mx-auto mb-4 rounded-full shadow-lg">
                    <h1 class="font-brand text-4xl font-bold text-slate-900">El Sabor que te Mueve</h1>
                    <p class="mt-2 text-slate-600 max-w-md mx-auto">Explora nuestro menú. Ingredientes frescos y recetas únicas directo a tu puerta.</p>
                </section>

                <!-- Filtros y Búsqueda -->
                <div class="sticky top-[72px] bg-slate-50 py-4 z-20">
                     <input id="search-box" type="search" placeholder="Buscar en el menú..." class="w-full px-4 py-3 rounded-full border-2 border-slate-200 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                     <nav id="category-chips" class="mt-4 flex gap-2 overflow-x-auto pb-2 -mx-4 px-4"></nav>
                </div>

                <!-- Contenido del Menú -->
                <div id="menu-content" class="mt-4">
                     <!-- Las categorías y platillos se insertarán aquí -->
                </div>
            </main>

            <!-- Botón flotante del carrito -->
            <div id="cart-fab-container" class="fixed bottom-6 right-6 z-40 transition-transform duration-300 transform translate-y-32">
                <button id="cart-fab" class="bg-indigo-600 text-white w-16 h-16 rounded-2xl shadow-lg flex items-center justify-center hover:bg-indigo-700 transition-all transform hover:scale-105">
                    <i class="fa-solid fa-cart-shopping text-2xl"></i>
                    <span id="cart-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center border-2 border-slate-50">0</span>
                </button>
            </div>
        </div>

        <!-- ======================================================= -->
        <!-- VISTA DEL PANEL DE ADMINISTRADOR                        -->
        <!-- ======================================================= -->
        <div id="admin-view" class="hidden">
            <!-- Pantalla de Contraseña -->
            <div id="password-prompt" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center slide-up">
                    <h2 class="text-2xl font-bold mb-2">Acceso de Administrador</h2>
                    <p class="text-slate-500 mb-6">Ingresa la contraseña para gestionar el menú.</p>
                    <input type="password" id="password-input" class="w-full text-center text-lg p-3 rounded-lg border-2 border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <button id="password-submit" class="w-full mt-4 bg-indigo-600 text-white font-bold py-3 px-6 rounded-full hover:bg-indigo-700 transition-shadow">Entrar</button>
                    <p id="password-error" class="text-red-500 text-sm mt-3 hidden">Contraseña incorrecta.</p>
                     <a href="#" class="block mt-4 text-sm text-slate-500 hover:text-indigo-600">Volver al menú</a>
                </div>
            </div>

            <!-- Contenido del Panel -->
            <div id="admin-panel" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
                <header class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold">Panel de Control</h1>
                    <a href="#" class="font-semibold text-indigo-600 hover:underline">Cerrar Panel</a>
                </header>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Columna de Categorías -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg space-y-6">
                        <h2 class="text-xl font-bold">Categorías</h2>
                        <form id="add-category-form" class="flex gap-2">
                            <input type="text" id="category-name-input" placeholder="Nueva categoría" class="flex-grow p-3 rounded-lg border-2 border-slate-200 focus:ring-indigo-500 outline-none" required>
                            <button type="submit" class="bg-indigo-600 text-white font-bold px-5 rounded-lg hover:bg-indigo-700 transition"><i class="fa-solid fa-plus"></i></button>
                        </form>
                        <ul id="category-list" class="space-y-2">
                            <!-- Las categorías se listarán aquí -->
                        </ul>
                    </div>

                    <!-- Columna de Platillos -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">Platillos del Menú</h2>
                            <button id="add-item-btn" class="bg-indigo-600 text-white font-bold py-2 px-5 rounded-full hover:bg-indigo-700 transition">
                                <i class="fa-solid fa-plus mr-2"></i>Añadir Platillo
                            </button>
                        </div>
                        <div id="admin-menu-items" class="space-y-2">
                           <!-- Los platillos se listarán aquí -->
                        </div>
                    </div>
                </div>
                 <!-- Zona de Peligro -->
                <div class="mt-8 bg-red-50 border-2 border-red-200 p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-red-800">Zona de Peligro</h2>
                    <p class="text-red-700 mt-2 mb-4">Esta acción es irreversible. Se borrarán todos los platillos y categorías actuales y se restaurará el menú original.</p>
                     <button id="restore-backup-btn" class="bg-red-600 text-white font-bold py-3 px-6 rounded-full hover:bg-red-700 transition-shadow">
                        <i class="fas fa-history mr-2"></i>Restaurar Copia de Seguridad
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- MODALES                                                 -->
    <!-- ======================================================= -->
    
    <!-- Modal del Carrito (Drawer) -->
    <div id="cart-modal" class="fixed inset-0 bg-black/50 z-40 hidden fade-out">
        <div id="cart-drawer" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl max-h-[85vh] flex flex-col transition-transform duration-300 transform translate-y-full">
            <header class="p-4 flex justify-between items-center border-b">
                <h2 class="text-xl font-bold">Tu Pedido</h2>
                <button id="close-cart-btn" class="text-slate-500 hover:text-slate-800 w-8 h-8 rounded-full"><i class="fa-solid fa-times text-xl"></i></button>
            </header>
            <div id="cart-items-container" class="p-4 overflow-y-auto flex-grow">
                <!-- Items del carrito se insertarán aquí -->
            </div>
            <footer class="p-4 border-t bg-slate-50 space-y-3">
                <div class="flex justify-between font-semibold">
                    <span>Subtotal</span>
                    <span id="cart-subtotal">RD$0.00</span>
                </div>
                 <div class="flex justify-between font-semibold">
                    <span>ITBIS (18%)</span>
                    <span id="cart-itbis">RD$0.00</span>
                </div>
                <div class="flex justify-between font-bold text-xl">
                    <span>Total</span>
                    <span id="cart-total">RD$0.00</span>
                </div>
                <input id="delivery-address" type="text" placeholder="Escribe tu dirección para el delivery" class="w-full mt-2 p-3 rounded-lg border-2 border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none">
                <button id="whatsapp-order-btn" class="w-full mt-2 bg-green-500 text-white font-bold py-4 rounded-full hover:bg-green-600 transition disabled:bg-slate-300 disabled:cursor-not-allowed">
                    <i class="fab fa-whatsapp mr-2"></i>Finalizar por WhatsApp
                </button>
            </footer>
        </div>
    </div>

    <!-- Modal para editar/añadir Platillo (Admin) -->
    <div id="item-modal" class="fixed inset-0 bg-black/50 z-50 p-4 hidden items-center justify-center">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col slide-up">
            <header class="p-4 border-b">
                <h2 id="modal-title" class="text-xl font-bold">Añadir Platillo</h2>
            </header>
            <form id="item-form" class="p-6 space-y-4 overflow-y-auto flex-grow">
                <input type="hidden" id="item-id">
                <div>
                    <label for="item-name" class="font-semibold mb-1 block">Nombre</label>
                    <input type="text" id="item-name" class="w-full p-3 rounded-lg border-2 border-slate-200" required>
                </div>
                 <div>
                    <label for="item-description" class="font-semibold mb-1 block">Descripción</label>
                    <textarea id="item-description" rows="3" class="w-full p-3 rounded-lg border-2 border-slate-200"></textarea>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label for="item-price" class="font-semibold mb-1 block">Precio Venta (RD$)</label>
                        <input type="number" id="item-price" step="0.01" class="w-full p-3 rounded-lg border-2 border-slate-200" required>
                    </div>
                     <div>
                        <label for="item-category" class="font-semibold mb-1 block">Categoría</label>
                        <select id="item-category" class="w-full p-3 rounded-lg border-2 border-slate-200 bg-white" required></select>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="item-visible" class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300" checked>
                    <label for="item-visible" class="font-semibold">Visible en el menú público</label>
                </div>
            </form>
             <footer class="p-4 flex justify-end gap-3 bg-slate-50 border-t rounded-b-2xl">
                <button type="button" id="cancel-item-btn" class="font-bold py-2 px-5 rounded-full hover:bg-slate-200 transition">Cancelar</button>
                <button type="submit" form="item-form" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-700 transition">Guardar</button>
            </footer>
        </div>
    </div>
    
    <!-- Modal de Confirmación de Pedido con Mapa -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black/50 z-50 p-4 hidden items-center justify-center">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md text-center p-8 slide-up">
            <i class="fa-solid fa-circle-check text-6xl text-green-500 mb-4"></i>
            <h2 class="text-2xl font-bold">¡Pedido enviado!</h2>
            <p class="text-slate-600 mt-2 mb-6">Hemos recibido tu pedido. Un representante te contactará en breve por WhatsApp para confirmar.</p>
            <div class="bg-slate-100 rounded-lg overflow-hidden">
                <h3 class="font-semibold p-3">Tu dirección de entrega:</h3>
                <img id="static-map" src="" alt="Mapa de la dirección de entrega" class="w-full h-48 object-cover">
                <p id="map-address" class="p-3 text-sm font-medium bg-slate-200"></p>
            </div>
            <button id="close-confirmation-modal" class="w-full mt-6 bg-indigo-600 text-white font-bold py-3 rounded-full hover:bg-indigo-700">Entendido</button>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, writeBatch, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // =======================================================
        // CONFIGURACIÓN Y ESTADO INICIAL
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCRfM3a9fA1kmMDcjC0PvT686vw2ZutrTo",
            authDomain: "squaso.firebaseapp.com",
            projectId: "squaso",
            storageBucket: "squaso.appspot.com",
            messagingSenderId: "295008368495",
            appId: "1:295008368495:web:dca64ef037b9e536675a9a"
        };

        const GOOGLE_MAPS_API_KEY = "REEMPLAZA_CON_TU_API_KEY_DE_GOOGLE_MAPS"; // IMPORTANTE!
        const WHATSAPP_NUMBER = "18491234567"; // Reemplaza con tu número de WhatsApp
        const ADMIN_PASSWORD = "palau"; // Contraseña para el panel de admin
        const ITBIS_RATE = 0.18;

        const appState = {
            categories: [],
            menuItems: [],
            cart: [],
            filter: {
                category: 'Todos',
                search: ''
            },
            adminSortable: null
        };

        // =======================================================
        // INICIALIZACIÓN DE FIREBASE
        // =======================================================
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const categoriesCol = collection(db, 'categories');
        const menuItemsCol = collection(db, 'menuItems');
        const categoriesQuery = query(categoriesCol, orderBy("order"));
        const menuItemsQuery = query(menuItemsCol, orderBy("name"));

        // =======================================================
        // FUNCIONES DE RENDERIZADO (VISTA)
        // =======================================================
        
        /** Formatea un número como moneda RD$ */
        const formatCurrency = (amount) => `RD$${Number(amount).toLocaleString('es-DO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        /** Renderiza las categorías como chips de filtro */
        const renderCategoryChips = () => {
            const container = document.getElementById('category-chips');
            const chips = ['Todos', ...appState.categories.map(c => c.name)];
            container.innerHTML = chips.map(name => `
                <button data-category="${name}" class="category-chip whitespace-nowrap text-sm font-semibold px-4 py-2 rounded-full transition ${appState.filter.category === name ? 'bg-indigo-600 text-white' : 'bg-white text-slate-700 hover:bg-slate-200'}">
                    ${name}
                </button>
            `).join('');
        };
        
        /** Renderiza la lista de platillos en el menú público */
        const renderMenu = () => {
            const content = document.getElementById('menu-content');
            content.innerHTML = ''; // Limpiar contenido anterior

            const filteredItems = appState.menuItems.filter(item => {
                const searchMatch = item.name.toLowerCase().includes(appState.filter.search);
                const categoryMatch = appState.filter.category === 'Todos' || item.categoryName === appState.filter.category;
                return item.visible && searchMatch && categoryMatch;
            });

            if (filteredItems.length === 0) {
                content.innerHTML = `<p class="text-center text-slate-500 py-10">No se encontraron platillos.</p>`;
                return;
            }

            const itemsByCategory = appState.categories.map(category => ({
                ...category,
                items: filteredItems.filter(item => item.categoryId === category.id)
            })).filter(category => category.items.length > 0);

            itemsByCategory.forEach(category => {
                const section = document.createElement('section');
                section.id = `category-${category.id}`;
                section.innerHTML = `
                    <h2 class="font-brand text-3xl font-bold text-slate-800 my-6">${category.name}</h2>
                    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${category.items.map(item => `
                            <div class="bg-white rounded-2xl shadow-md overflow-hidden flex flex-col transition transform hover:-translate-y-1">
                                <div class="p-5 flex-grow">
                                    <h3 class="font-bold text-lg">${item.name}</h3>
                                    <p class="text-slate-600 text-sm mt-1">${item.description || ''}</p>
                                </div>
                                <div class="p-5 bg-slate-50 flex justify-between items-center">
                                    <span class="font-bold text-lg text-indigo-600">${formatCurrency(item.price)}</span>
                                    <button data-item-id="${item.id}" class="add-to-cart-btn bg-indigo-100 text-indigo-700 font-bold w-10 h-10 rounded-full hover:bg-indigo-200 transition">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                content.appendChild(section);
            });
        };

        /** Renderiza el contenido del carrito */
        const renderCart = () => {
            const itemsContainer = document.getElementById('cart-items-container');
            const fabContainer = document.getElementById('cart-fab-container');
            const badge = document.getElementById('cart-badge');
            
            const totalItems = appState.cart.reduce((sum, item) => sum + item.quantity, 0);

            if (totalItems > 0) {
                fabContainer.classList.remove('translate-y-32');
            } else {
                fabContainer.classList.add('translate-y-32');
                toggleModal('cart-modal', false);
            }
            
            badge.textContent = totalItems;
            
            if (appState.cart.length === 0) {
                itemsContainer.innerHTML = `<p class="text-center text-slate-500 py-10">Tu carrito está vacío.</p>`;
            } else {
                 itemsContainer.innerHTML = appState.cart.map(item => `
                    <div class="flex items-center gap-4 py-3 border-b">
                        <div class="flex-grow">
                            <p class="font-bold">${item.name}</p>
                            <p class="text-sm text-slate-500">${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button data-item-id="${item.id}" class="cart-quantity-change bg-slate-200 w-7 h-7 rounded-full font-bold" data-change="-1">-</button>
                            <span class="font-bold w-5 text-center">${item.quantity}</span>
                            <button data-item-id="${item.id}" class="cart-quantity-change bg-slate-200 w-7 h-7 rounded-full font-bold" data-change="1">+</button>
                        </div>
                        <p class="font-bold w-24 text-right">${formatCurrency(item.price * item.quantity)}</p>
                    </div>
                 `).join('');
            }
            
            const subtotal = appState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itbis = subtotal * ITBIS_RATE;
            const total = subtotal + itbis;

            document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('cart-itbis').textContent = formatCurrency(itbis);
            document.getElementById('cart-total').textContent = formatCurrency(total);
            document.getElementById('whatsapp-order-btn').disabled = appState.cart.length === 0 || document.getElementById('delivery-address').value.trim() === '';
        };

        // =======================================================
        // FUNCIONES DE RENDERIZADO (ADMIN)
        // =======================================================
        
        /** Renderiza la lista de categorías en el panel de admin */
        const renderAdminCategories = () => {
            const list = document.getElementById('category-list');
            list.innerHTML = appState.categories.map(cat => `
                <li data-id="${cat.id}" class="flex items-center justify-between p-3 bg-slate-100 rounded-lg">
                    <div class="flex items-center">
                        <i class="fa-solid fa-grip-vertical cursor-grab text-slate-400 mr-3"></i>
                        <span class="font-semibold">${cat.name}</span>
                    </div>
                    <button data-id="${cat.id}" class="delete-category-btn text-red-500 hover:text-red-700 w-8 h-8 rounded-full"><i class="fa-solid fa-trash-can"></i></button>
                </li>
            `).join('');
        };
        
        /** Renderiza la lista de platillos en el panel de admin */
        const renderAdminMenuItems = () => {
            const container = document.getElementById('admin-menu-items');
             container.innerHTML = appState.menuItems.map(item => `
                <div class="flex items-center justify-between p-3 border-b">
                     <div>
                        <p class="font-bold">${item.name}</p>
                        <p class="text-sm text-slate-500">${item.categoryName || 'Sin categoría'} - ${formatCurrency(item.price)} - <span class="${item.visible ? 'text-green-600' : 'text-red-600'}">${item.visible ? 'Visible' : 'Oculto'}</span></p>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${item.id}" class="edit-item-btn bg-slate-200 text-slate-700 w-10 h-10 rounded-full hover:bg-slate-300"><i class="fa-solid fa-pencil"></i></button>
                        <button data-id="${item.id}" class="delete-item-btn bg-red-100 text-red-600 w-10 h-10 rounded-full hover:bg-red-200"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
             `).join('');
        };

        // =======================================================
        // LÓGICA DE NEGOCIO (CONTROLADOR)
        // =======================================================

        /** Añade un platillo al carrito o incrementa su cantidad */
        const addToCart = (itemId) => {
            const existingItem = appState.cart.find(item => item.id === itemId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                const item = appState.menuItems.find(i => i.id === itemId);
                appState.cart.push({ ...item, quantity: 1 });
            }
            renderCart();
        };

        /** Cambia la cantidad de un platillo en el carrito */
        const changeCartQuantity = (itemId, change) => {
            const itemInCart = appState.cart.find(item => item.id === itemId);
            if (!itemInCart) return;
            
            itemInCart.quantity += change;
            
            if (itemInCart.quantity <= 0) {
                appState.cart = appState.cart.filter(item => item.id !== itemId);
            }
            renderCart();
        };
        
        /** Construye el mensaje de WhatsApp para el pedido */
        const buildWhatsAppMessage = () => {
            const address = document.getElementById('delivery-address').value.trim();
            const subtotal = appState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itbis = subtotal * ITBIS_RATE;
            const total = subtotal + itbis;

            let message = "*¡Nuevo Pedido desde Menú Digital!* 🍔\n\n";
            message += "*Platillos:*\n";
            appState.cart.forEach(item => {
                message += `• ${item.quantity}x ${item.name} - ${formatCurrency(item.price * item.quantity)}\n`;
            });
            message += "\n---------------------\n";
            message += `*Subtotal:* ${formatCurrency(subtotal)}\n`;
            message += `*ITBIS (18%):* ${formatCurrency(itbis)}\n`;
            message += `*Total a Pagar:* *${formatCurrency(total)}*\n`;
            message += "\n---------------------\n";
            message += `*Dirección de Entrega:*\n${address}`;

            return encodeURIComponent(message);
        };
        
        /** Abre o cierra un modal */
        const toggleModal = (modalId, show) => {
            const modal = document.getElementById(modalId);
            const drawer = modal.querySelector('#cart-drawer'); // Específico para el carrito

            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('fade-out');
                    if(drawer) drawer.classList.remove('translate-y-full');
                }, 10);
            } else {
                modal.classList.add('fade-out');
                if(drawer) drawer.classList.add('translate-y-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        };

        // =======================================================
        // LÓGICA DE ADMINISTRADOR
        // =======================================================
        
        /** Abre el modal para añadir o editar un platillo */
        const openItemModal = (itemId = null) => {
            const form = document.getElementById('item-form');
            form.reset();
            document.getElementById('item-id').value = '';
            
            const categorySelect = document.getElementById('item-category');
            categorySelect.innerHTML = appState.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            if (itemId) {
                const item = appState.menuItems.find(i => i.id === itemId);
                document.getElementById('modal-title').textContent = 'Editar Platillo';
                document.getElementById('item-id').value = item.id;
                document.getElementById('item-name').value = item.name;
                document.getElementById('item-description').value = item.description;
                document.getElementById('item-price').value = item.price;
                document.getElementById('item-category').value = item.categoryId;
                document.getElementById('item-visible').checked = item.visible;
            } else {
                document.getElementById('modal-title').textContent = 'Añadir Platillo';
                 document.getElementById('item-visible').checked = true;
            }
            toggleModal('item-modal', true);
        };

        /** Guarda un platillo (nuevo o existente) en Firestore */
        const handleItemFormSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('item-id').value;
            const categoryId = document.getElementById('item-category').value;
            const category = appState.categories.find(c => c.id === categoryId);

            const itemData = {
                name: document.getElementById('item-name').value.trim(),
                description: document.getElementById('item-description').value.trim(),
                price: parseFloat(document.getElementById('item-price').value),
                categoryId: categoryId,
                categoryName: category ? category.name : '',
                visible: document.getElementById('item-visible').checked
            };
            
            try {
                if (id) {
                    await updateDoc(doc(db, 'menuItems', id), itemData);
                } else {
                    await addDoc(menuItemsCol, itemData);
                }
                toggleModal('item-modal', false);
            } catch (error) {
                console.error("Error guardando el platillo:", error);
                alert("Hubo un error al guardar.");
            }
        };
        
        /** Restaura el menú desde una copia de seguridad hardcodeada */
        const restoreBackup = async () => {
             if (!confirm("¿Estás seguro? Esta acción borrará TODO el menú actual y lo reemplazará con la copia de seguridad.")) return;
            
            const backup = {
                categories: [
                    { id: "burgers", name: "Hamburguesas", order: 0 },
                    { id: "pizzas", name: "Pizzas", order: 1 },
                    { id: "bebidas", name: "Bebidas", order: 2 }
                ],
                menuItems: [
                    { name: "Clásica Burger", description: "Carne de res, lechuga, tomate, queso y salsa especial.", price: 350, categoryId: "burgers", visible: true },
                    { name: "Doble Queso Burger", description: "Doble carne, doble queso cheddar, tocineta y cebolla caramelizada.", price: 480, categoryId: "burgers", visible: true },
                    { name: "Pizza Pepperoni", description: "Salsa de tomate, mozzarella y pepperoni de primera.", price: 550, categoryId: "pizzas", visible: true },
                    { name: "Pizza Margarita", description: "La clásica con albahaca fresca.", price: 500, categoryId: "pizzas", visible: false },
                    { name: "Refresco Coca-Cola", description: "Lata de 355ml.", price: 75, categoryId: "bebidas", visible: true },
                ]
            };

            try {
                const batch = writeBatch(db);
                
                // Borrar todo lo existente
                appState.categories.forEach(c => batch.delete(doc(db, 'categories', c.id)));
                appState.menuItems.forEach(i => batch.delete(doc(db, 'menuItems', i.id)));
                
                // Escribir la copia de seguridad
                backup.categories.forEach(c => {
                    const {id, ...data} = c;
                    data.categoryName = c.name;
                    batch.set(doc(db, 'categories', id), data);
                });
                backup.menuItems.forEach(i => {
                    const category = backup.categories.find(c => c.id === i.categoryId);
                    i.categoryName = category.name;
                    batch.set(doc(collection(db, 'menuItems')), i);
                });

                await batch.commit();
                alert("Menú restaurado con éxito.");
            } catch (error) {
                console.error("Error restaurando la copia de seguridad:", error);
                alert("Ocurrió un error al restaurar.");
            }
        };

        // =======================================================
        // MANEJO DE EVENTOS
        // =======================================================
        const setupEventListeners = () => {
            document.body.addEventListener('click', async (e) => {
                // Filtro de categoría
                const categoryChip = e.target.closest('.category-chip');
                if (categoryChip) {
                    appState.filter.category = categoryChip.dataset.category;
                    renderCategoryChips();
                    renderMenu();
                }

                // Añadir al carrito
                const addToCartBtn = e.target.closest('.add-to-cart-btn');
                if (addToCartBtn) {
                    addToCart(addToCartBtn.dataset.itemId);
                }

                // Abrir/Cerrar carrito
                if (e.target.closest('#cart-fab') || e.target.closest('#close-cart-btn')) {
                    const isCartOpen = !document.getElementById('cart-modal').classList.contains('hidden');
                    toggleModal('cart-modal', !isCartOpen);
                }
                
                // Cambiar cantidad en carrito
                const quantityBtn = e.target.closest('.cart-quantity-change');
                if (quantityBtn) {
                    const change = parseInt(quantityBtn.dataset.change, 10);
                    changeCartQuantity(quantityBtn.dataset.itemId, change);
                }

                // Finalizar por WhatsApp
                if (e.target.closest('#whatsapp-order-btn')) {
                    const address = document.getElementById('delivery-address').value.trim();
                    if (!address) {
                        alert("Por favor, introduce tu dirección.");
                        return;
                    }
                    const message = buildWhatsAppMessage();
                    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${message}`, "_blank");
                    
                    // Mostrar modal de confirmación con mapa
                    document.getElementById('map-address').textContent = address;
                    const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${encodeURIComponent(address)}&zoom=15&size=600x300&markers=color:red%7C${encodeURIComponent(address)}&key=${GOOGLE_MAPS_API_KEY}`;
                    document.getElementById('static-map').src = mapUrl;
                    toggleModal('cart-modal', false);
                    toggleModal('confirmation-modal', true);
                }
                
                if(e.target.closest('#close-confirmation-modal')) {
                    appState.cart = [];
                    renderCart();
                    toggleModal('confirmation-modal', false);
                }

                // --- Eventos de Admin ---
                
                // Añadir categoría
                const addCategoryForm = e.target.closest('#add-category-form');
                if (addCategoryForm) {
                    e.preventDefault();
                    const input = document.getElementById('category-name-input');
                    const name = input.value.trim();
                    if (name) {
                        const order = appState.categories.length;
                        await addDoc(categoriesCol, { name, order });
                        input.value = '';
                    }
                }

                // Borrar categoría
                const deleteCategoryBtn = e.target.closest('.delete-category-btn');
                if (deleteCategoryBtn) {
                     if (confirm("¿Seguro que quieres borrar esta categoría?")) {
                        await deleteDoc(doc(db, 'categories', deleteCategoryBtn.dataset.id));
                    }
                }
                
                // Abrir modal para añadir platillo
                if (e.target.closest('#add-item-btn')) {
                    openItemModal();
                }

                // Abrir modal para editar platillo
                const editItemBtn = e.target.closest('.edit-item-btn');
                if (editItemBtn) {
                    openItemModal(editItemBtn.dataset.id);
                }

                // Borrar platillo
                 const deleteItemBtn = e.target.closest('.delete-item-btn');
                if (deleteItemBtn) {
                     if (confirm("¿Seguro que quieres borrar este platillo?")) {
                        await deleteDoc(doc(db, 'menuItems', deleteItemBtn.dataset.id));
                    }
                }

                // Cancelar modal de platillo
                if (e.target.closest('#cancel-item-btn')) {
                    toggleModal('item-modal', false);
                }
                
                // Restaurar copia de seguridad
                if (e.target.closest('#restore-backup-btn')) {
                    restoreBackup();
                }
            });

            // Búsqueda
            document.getElementById('search-box').addEventListener('input', (e) => {
                appState.filter.search = e.target.value.trim().toLowerCase();
                renderMenu();
            });
            
            // Envío del formulario de platillo
            document.getElementById('item-form').addEventListener('submit', handleItemFormSubmit);
            
            // Validar que el botón de WhatsApp se active/desactive
            document.getElementById('delivery-address').addEventListener('input', renderCart);
        };
        
        // =======================================================
        // LÓGICA DE NAVEGACIÓN Y VISTAS
        // =======================================================
        const handleRouting = () => {
            const hash = window.location.hash;
            const publicView = document.getElementById('public-view');
            const adminView = document.getElementById('admin-view');
            const passwordPrompt = document.getElementById('password-prompt');
            const adminPanel = document.getElementById('admin-panel');

            if (hash === '#admin') {
                publicView.classList.add('hidden');
                adminView.classList.remove('hidden');
                passwordPrompt.classList.remove('hidden');
                passwordPrompt.classList.add('flex');
                adminPanel.classList.add('hidden');
            } else {
                publicView.classList.remove('hidden');
                adminView.classList.add('hidden');
            }
        };

        const setupAdminAuth = () => {
            const passwordInput = document.getElementById('password-input');
            const passwordSubmit = document.getElementById('password-submit');
            const passwordError = document.getElementById('password-error');

            const attemptLogin = () => {
                if (passwordInput.value === ADMIN_PASSWORD) {
                    document.getElementById('password-prompt').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                    passwordError.classList.add('hidden');
                } else {
                    passwordError.classList.remove('hidden');
                }
            };
            
            passwordSubmit.addEventListener('click', attemptLogin);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') attemptLogin();
            });

            // Salir del panel de admin
            document.querySelector('#admin-panel a').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = '';
                passwordInput.value = '';
            });
             document.querySelector('#password-prompt a').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = '';
            });
        };
        
        // =======================================================
        // PUNTO DE ENTRADA PRINCIPAL
        // =======================================================
        const init = () => {
            // Listeners de Firestore
            onSnapshot(categoriesQuery, (snapshot) => {
                appState.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategoryChips();
                renderMenu();
                renderAdminCategories();
                
                // Inicializar o re-inicializar SortableJS
                if (appState.adminSortable) appState.adminSortable.destroy();
                const el = document.getElementById('category-list');
                appState.adminSortable = Sortable.create(el, {
                    animation: 150,
                    handle: '.fa-grip-vertical',
                    onEnd: async (evt) => {
                        const batch = writeBatch(db);
                        el.querySelectorAll('li').forEach((li, index) => {
                            const docRef = doc(db, 'categories', li.dataset.id);
                            batch.update(docRef, { order: index });
                        });
                        await batch.commit();
                    }
                });
            });

            onSnapshot(menuItemsQuery, (snapshot) => {
                const itemsWithCategoryName = snapshot.docs.map(docSnap => {
                    const data = docSnap.data();
                    const category = appState.categories.find(c => c.id === data.categoryId);
                    return {
                        id: docSnap.id,
                        ...data,
                        categoryName: category ? category.name : 'Sin categoría'
                    };
                });
                appState.menuItems = itemsWithCategoryName;
                renderMenu();
                renderAdminMenuItems();
            });
            
            setupEventListeners();
            handleRouting();
            setupAdminAuth();
            window.addEventListener('hashchange', handleRouting);
        };

        // Iniciar la aplicación
        init();

    </script>
</body>
</html>
